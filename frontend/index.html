<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Conversation Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/react-icons@4.10.1/fi/index.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Add some custom transitions and animations */
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        .hover-scale:hover {
            transform: scale(1.05);
        }
        .active-scale:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Create the application component
        const AIConversationSimulator = () => {
            const [agentPrompt, setAgentPrompt] = React.useState("");
            const [userPrompts, setUserPrompts] = React.useState([{ id: 1, content: "", selected: true }]);
            const [conversations, setConversations] = React.useState([]);
            const [isSimulating, setIsSimulating] = React.useState(false);
            const [isDarkMode, setIsDarkMode] = React.useState(false);
            const [connectionStatus, setConnectionStatus] = React.useState("disconnected");
            const websocketRef = React.useRef(null);
            const clientIdRef = React.useRef(`client-${Date.now()}`);
            const [agentMode, setAgentMode] = React.useState("prompt");
            const [botId, setBotId] = React.useState(16);
            const [maxTurns, setMaxTurns] = React.useState(5);

            // Initialize WebSocket connection
            React.useEffect(() => {
                const connectWebSocket = () => {
                    // Hardcode the WebSocket URL for testing
                    const wsUrl = window.location.hostname === 'localhost' 
                        ? 'ws://localhost:25050' 
                        : `ws://${window.location.hostname}:25050`;
                    const ws = new WebSocket(`${wsUrl}/ws/${clientIdRef.current}`);
                    
                    ws.onopen = () => {
                        console.log("WebSocket connected");
                        setConnectionStatus("connected");
                    };
                    
                    ws.onclose = () => {
                        console.log("WebSocket disconnected");
                        setConnectionStatus("disconnected");
                        // Try to reconnect after 2 seconds
                        setTimeout(connectWebSocket, 2000);
                    };
                    
                    ws.onerror = (error) => {
                        console.error("WebSocket error:", error);
                        setConnectionStatus("error");
                    };
                    
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        console.log("Message received:", data);
                        
                        if (data.type === "conversations_created") {
                            // Initialize new conversations
                            const newConversations = data.conversations.map(conv => ({
                                id: conv.id,
                                userPromptId: conv.userPromptId,
                                status: conv.status,
                                messages: []
                            }));
                            
                            setConversations(prev => [...prev, ...newConversations]);
                        } 
                        else if (data.type === "message") {
                            // Add new message to the appropriate conversation
                            setConversations(prev => 
                                prev.map(conv => 
                                    conv.id === data.conversation_id
                                        ? {
                                            ...conv,
                                            messages: [...conv.messages, {
                                                role: data.message.role,
                                                content: data.message.content,
                                                timestamp: data.message.timestamp
                                            }]
                                        }
                                        : conv
                                )
                            );
                        }
                        else if (data.type === "completion") {
                            // Mark conversation as completed
                            setConversations(prev => 
                                prev.map(conv => 
                                    conv.id === data.conversation_id
                                        ? { ...conv, status: "completed" }
                                        : conv
                                )
                            );
                        }
                    };
                    
                    websocketRef.current = ws;
                    
                    return () => {
                        ws.close();
                    };
                };
                
                connectWebSocket();
                
                return () => {
                    if (websocketRef.current) {
                        websocketRef.current.close();
                    }
                };
            }, []);

            const addNewPrompt = () => {
                setUserPrompts([...userPrompts, { id: Date.now(), content: "", selected: true }]);
            };

            const togglePromptSelection = (id) => {
                setUserPrompts(userPrompts.map(prompt =>
                    prompt.id === id ? { ...prompt, selected: !prompt.selected } : prompt
                ));
            };

            const updatePromptText = (id, content) => {
                setUserPrompts(userPrompts.map(prompt =>
                    prompt.id === id ? { ...prompt, content } : prompt
                ));
            };

            const deletePrompt = (id) => {
                setUserPrompts(userPrompts.filter(prompt => prompt.id !== id));
            };

            const startSimulation = () => {
                if (agentMode === "prompt" && agentPrompt.trim() === "") {
                    alert("Please enter an agent prompt or select Bot ID mode.");
                    return;
                }

                const selectedPrompts = userPrompts.filter(p => p.selected);
                if (selectedPrompts.length === 0) {
                    alert("Please select at least one user prompt.");
                    return;
                }

                setIsSimulating(true);
                setConversations([]);

                const message = {
                    type: "start_conversation",
                    agent_mode: agentMode,
                    agent_prompt: agentPrompt,
                    bot_id: botId,
                    user_prompts: selectedPrompts,
                    max_turns: maxTurns
                };

                if (websocketRef.current && websocketRef.current.readyState === WebSocket.OPEN) {
                    websocketRef.current.send(JSON.stringify(message));
                }
            };

            const resetSimulation = () => {
                setConversations([]);
                setUserPrompts([{ id: 1, content: "", selected: true }]);
                setAgentPrompt("");
                setIsSimulating(false);
            };

            return (
                <div className={`min-h-screen p-4 ${isDarkMode ? "bg-gradient-to-b from-gray-900 to-gray-800" : "bg-gradient-to-b from-gray-50 to-white"} text-gray-900`}>
                    <div className="max-w-4xl mx-auto">
                        {/* Header with Dark Mode Toggle */}
                        <div className="sticky top-0 z-50 backdrop-blur-lg bg-opacity-70 p-4 rounded-2xl mb-6 flex justify-between items-center">
                            <h1 className={`text-2xl font-bold ${isDarkMode ? "text-white" : "text-gray-800"}`}>
                                AI Conversation Simulator
                            </h1>
                            <div className="flex items-center gap-3">
                                <span className={`text-sm ${isDarkMode ? "text-gray-300" : "text-gray-600"}`}>
                                    {connectionStatus === "connected" ? "Connected" : 
                                     connectionStatus === "disconnected" ? "Disconnected" : "Error"}
                                </span>
                                <button
                                    onClick={() => setIsDarkMode(!isDarkMode)}
                                    className="px-6 py-2.5 rounded-full bg-blue-500 hover:bg-blue-600 text-white font-medium transform transition-all duration-200 hover-scale active-scale shadow-lg"
                                >
                                    {isDarkMode ? "Light Mode" : "Dark Mode"}
                                </button>
                            </div>
                        </div>

                        {/* Agent Mode Selection */}
                        <div className={`backdrop-blur-xl bg-opacity-80 p-6 rounded-2xl shadow-xl mb-6 transform transition-all duration-300 hover:shadow-2xl`}
                            style={{ backgroundColor: isDarkMode ? "rgba(26, 26, 26, 0.8)" : "rgba(255, 255, 255, 0.8)" }}
                        >
                            <div className="flex items-center mb-4 justify-between">
                                <label className={`font-semibold text-lg ${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                    Agent Mode
                                </label>
                                <div className="flex items-center space-x-6">
                                    <div className="flex items-center">
                                        <input
                                            type="radio"
                                            id="promptModeRadio"
                                            name="agentMode"
                                            className="mr-2 w-5 h-5"
                                            checked={agentMode === "prompt"}
                                            onChange={() => setAgentMode("prompt")}
                                        />
                                        <label htmlFor="promptModeRadio" className={`${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                            Use Prompt
                                        </label>
                                    </div>
                                    <div className="flex items-center">
                                        <input
                                            type="radio"
                                            id="botIdModeRadio"
                                            name="agentMode"
                                            className="mr-2 w-5 h-5"
                                            checked={agentMode === "bot_id"}
                                            onChange={() => setAgentMode("bot_id")}
                                        />
                                        <label htmlFor="botIdModeRadio" className={`${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                            Use Bot ID
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            {agentMode === "bot_id" && (
                                <div className="mb-2">
                                    <label className={`block mb-2 ${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                        Bot ID:
                                    </label>
                                    <input
                                        type="number"
                                        value={botId}
                                        onChange={(e) => setBotId(parseInt(e.target.value) || 16)}
                                        placeholder="Enter Bot ID"
                                        className={`w-full p-3 border-2 rounded-xl focus:ring-4 focus:ring-blue-500/20 outline-none transition-all duration-200 ${
                                            isDarkMode ? "bg-gray-700/50 border-gray-600 text-white" : "bg-white/50 border-gray-200 text-black"
                                        }`}
                                    />
                                </div>
                            )}

                            <div className="mb-4">
                                <label className={`block mb-2 ${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                    Max Conversation Turns:
                                </label>
                                <input
                                    type="number"
                                    value={maxTurns}
                                    onChange={(e) => setMaxTurns(parseInt(e.target.value) || 5)}
                                    min="1"
                                    max="20"
                                    className={`w-full p-3 border-2 rounded-xl focus:ring-4 focus:ring-blue-500/20 outline-none transition-all duration-200 ${
                                        isDarkMode ? "bg-gray-700/50 border-gray-600 text-white" : "bg-white/50 border-gray-200 text-black"
                                    }`}
                                    disabled={isSimulating}
                                />
                                <p className={`text-sm mt-1 ${isDarkMode ? "text-gray-400" : "text-gray-500"}`}>
                                    Number of back-and-forth exchanges in the conversation (1-20)
                                </p>
                            </div>
                        </div>

                        {/* Agent Prompt Input */}
                        {agentMode === "prompt" && (
                            <div className="backdrop-blur-xl bg-opacity-80 p-6 rounded-2xl shadow-xl mb-6 transform transition-all duration-300 hover:shadow-2xl"
                                style={{ backgroundColor: isDarkMode ? "rgba(26, 26, 26, 0.8)" : "rgba(255, 255, 255, 0.8)" }}
                            >
                                <textarea
                                    value={agentPrompt}
                                    onChange={(e) => setAgentPrompt(e.target.value)}
                                    placeholder="Enter Agent Prompt"
                                    className={`w-full p-4 rounded-xl border-2 focus:ring-4 focus:ring-blue-500/20 outline-none transition-all duration-200 ${isDarkMode ? "bg-gray-800/50 border-gray-700 text-white" : "bg-white/50 border-gray-200 text-black"}`}
                                    rows="4"
                                    disabled={isSimulating}
                                />
                            </div>
                        )}

                        {/* User Prompts Section */}
                        <div className={`p-8 rounded-2xl mb-8 shadow-xl backdrop-blur-lg transition-all duration-300 hover:shadow-2xl`}
                            style={{ backgroundColor: isDarkMode ? "rgba(31, 41, 55, 0.9)" : "rgba(255, 255, 255, 0.9)" }}
                        >
                            <h2 className={`text-2xl font-bold mb-6 ${isDarkMode ? "text-white" : "text-gray-800"}`}>User Prompts</h2>
                            <div className="space-y-4">
                                {userPrompts.map((prompt) => (
                                    <div key={prompt.id} className="flex items-center gap-4 group">
                                        <input
                                            type="checkbox"
                                            checked={prompt.selected}
                                            onChange={() => togglePromptSelection(prompt.id)}
                                            className="w-6 h-6 rounded-lg text-blue-500 transition-transform duration-200 hover:scale-110"
                                            disabled={isSimulating}
                                        />
                                        <input
                                            type="text"
                                            value={prompt.content}
                                            onChange={(e) => updatePromptText(prompt.id, e.target.value)}
                                            placeholder={`User Prompt ${prompt.id}`}
                                            className={`flex-1 p-3 rounded-xl border-2 transition-all duration-200 focus:ring-4 focus:ring-blue-500/20 ${
                                                isDarkMode ? "bg-gray-700/50 border-gray-600 text-white" : "bg-gray-50/50 border-gray-200 text-black"
                                            }`}
                                            disabled={isSimulating}
                                        />
                                        <button
                                            onClick={() => deletePrompt(prompt.id)}
                                            className={`p-3 text-red-500 hover:bg-red-100/20 rounded-full transition-all duration-200 hover:scale-110 active:scale-95 ${
                                                isSimulating || userPrompts.length <= 1 ? "opacity-50 cursor-not-allowed" : ""
                                            }`}
                                            disabled={isSimulating || userPrompts.length <= 1}
                                        >
                                            <span role="img" aria-label="delete">🗑️</span>
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <button
                                onClick={addNewPrompt}
                                className={`mt-6 flex items-center gap-2 px-6 py-3 bg-green-500 text-white rounded-full hover:bg-green-600 transform transition-all duration-200 hover-scale active-scale shadow-lg ${
                                    isSimulating ? "opacity-50 cursor-not-allowed" : ""
                                }`}
                                disabled={isSimulating}
                            >
                                <span role="img" aria-label="add">➕</span> Add New Prompt
                            </button>
                        </div>

                        {/* Control Buttons */}
                        <div className="flex gap-4 mb-8">
                            <button
                                onClick={startSimulation}
                                disabled={isSimulating}
                                className={`flex-1 py-4 px-8 rounded-full flex items-center justify-center gap-3 ${
                                    isSimulating ? "bg-gray-400 cursor-not-allowed" : "bg-blue-500 hover:bg-blue-600"
                                } text-white font-medium transform transition-all duration-200 hover-scale active-scale shadow-lg`}
                            >
                                <span role="img" aria-label="play">▶️</span> {isSimulating ? "Simulating..." : "Start Simulation"}
                            </button>
                            <button
                                onClick={resetSimulation}
                                className={`flex items-center gap-3 px-8 py-4 bg-red-500 text-white rounded-full hover:bg-red-600 transform transition-all duration-200 hover-scale active-scale shadow-lg ${
                                    isSimulating ? "opacity-50 cursor-not-allowed" : ""
                                }`}
                                disabled={isSimulating}
                            >
                                <span role="img" aria-label="reset">🔄</span> Reset
                            </button>
                        </div>

                        {/* Conversations Display */}
                        <div className="space-y-8">
                            {conversations.length === 0 && !isSimulating && (
                                <div className={`p-6 rounded-2xl shadow-xl backdrop-blur-lg text-center transition-all duration-300 hover:shadow-2xl`}
                                    style={{ backgroundColor: isDarkMode ? "rgba(31, 41, 55, 0.9)" : "rgba(255, 255, 255, 0.9)" }}
                                >
                                    <p className={`${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                        No conversations yet. Configure your prompts and start a simulation.
                                    </p>
                                </div>
                            )}
                            
                            {conversations.map((conv) => (
                                <div
                                    key={conv.id}
                                    className={`p-6 rounded-2xl shadow-xl backdrop-blur-lg transition-all duration-300 hover:shadow-2xl`}
                                    style={{ backgroundColor: isDarkMode ? "rgba(31, 41, 55, 0.9)" : "rgba(255, 255, 255, 0.9)" }}
                                >
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className={`text-xl font-semibold ${isDarkMode ? "text-white" : "text-gray-800"}`}>
                                            Conversation #{String(conv.id).substring(0, 8)}...
                                        </h3>
                                        <span className={`px-3 py-1.5 rounded-full text-xs ${
                                            conv.status === "completed" ? "bg-green-500" : "bg-yellow-500"
                                        } text-white font-medium`}>
                                            {conv.status === "completed" ? "Completed" : "In Progress"}
                                        </span>
                                    </div>
                                    
                                    <div className="space-y-6">
                                        {conv.messages.length === 0 ? (
                                            <div className={`text-center ${isDarkMode ? "text-gray-400" : "text-gray-500"}`}>
                                                Waiting for messages...
                                            </div>
                                        ) : (
                                            conv.messages.map((msg, idx) => (
                                                <div
                                                    key={idx}
                                                    className={`flex ${msg.role === "Agent" ? "justify-start" : "justify-end"}`}
                                                >
                                                    <div
                                                        className={`max-w-[70%] p-4 rounded-2xl transform transition-all duration-200 hover:scale-102 ${
                                                            msg.role === "Agent" 
                                                                ? (isDarkMode ? "bg-blue-600/40" : "bg-blue-100") 
                                                                : (isDarkMode ? "bg-green-600/40" : "bg-green-100")
                                                        }`}
                                                    >
                                                        <p className={`text-sm font-semibold mb-2 ${isDarkMode ? "text-white" : "text-gray-800"}`}>
                                                            {msg.role}
                                                        </p>
                                                        <p className={`leading-relaxed ${isDarkMode ? "text-white" : "text-gray-800"}`}>
                                                            {msg.content}
                                                        </p>
                                                        <p className={`text-xs mt-2 ${isDarkMode ? "text-gray-400" : "text-gray-500"}`}>
                                                            {new Date(msg.timestamp).toLocaleTimeString()}
                                                        </p>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Use the modern React 18 API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AIConversationSimulator />);
    </script>
</body>
</html> 