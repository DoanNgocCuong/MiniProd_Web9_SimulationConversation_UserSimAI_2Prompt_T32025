<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Conversation Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/react-icons@4.10.1/fi/index.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Add some custom transitions and animations */
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        .hover-scale:hover {
            transform: scale(1.05);
        }
        .active-scale:active {
            transform: scale(0.95);
        }
        /* Add styling for code blocks in messages */
        pre {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .dark pre {
            background-color: rgba(255, 255, 255, 0.1);
        }
        code {
            font-family: monospace;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(100,100,100,0.6);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(100,100,100,0.8);
        }
        
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
        }
        
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(200,200,200,0.4);
        }
        
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(200,200,200,0.6);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Hàm định dạng nội dung tin nhắn, xử lý code blocks và các định dạng khác
        const formatMessageContent = (content) => {
            if (!content) return "";
            
            // Kiểm tra xem content có phải là object không
            if (typeof content === 'object') {
                return JSON.stringify(content, null, 2);
            }
            
            // Xử lý code blocks (nếu có)
            let formattedContent = content;
            
            // Trả về nội dung đã định dạng
            return formattedContent;
        };

        // Hàm chuyển đổi nội dung prompt từ định dạng cũ sang định dạng mới
        const updatePromptFormat = (oldContent) => {
            // Chỉ cập nhật nếu chưa được cập nhật (bắt đầu bằng "ROLE: You are")
            if (!oldContent.startsWith("ROLE: You are")) {
                return oldContent; // Đã được cập nhật rồi
            }
            
            // Trích xuất phần thông tin user từ nội dung cũ
            const userInfoPart = oldContent
                .replace("ROLE: You are\n", "") // Bỏ phần "ROLE: You are"
                .replace("\nYou are:", ""); // Bỏ phần "You are:" ở cuối
            
            // Tạo template mới
            return `You are:
${userInfoPart}
======

TASK: Your task is follow each step the ROBOT guides you.

**RESPONSE TEMPLATE** 
- Response in Vietnamese. 
- Super short answers with phrases. 
- Answer 2-3 phrases max, each phrase 3-4 words. Phrases should be CONTIGUOUS, NOT ON NEW LINES, SEPARATED BY A PERIOD. Contiguous phrases should not go to a new line. 
- Use "Tớ" for myself and "Cậu" for the user. 
- NO ICON, and no emoji in output 

You respond extremely briefly.`;
        };

        // Cập nhật hàm định dạng thời gian để hiển thị ngắn gọn hơn
        const formatTime = (timestamp) => {
            if (!timestamp) return "N/A";
            const date = new Date(timestamp);
            // Chỉ hiển thị giờ và phút, không hiển thị giây và AM/PM
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        };

        // Create the application component
        const AIConversationSimulator = () => {
            const [agentPrompt, setAgentPrompt] = React.useState("");
            const [userPrompts, setUserPrompts] = React.useState([
                { 
                    id: 1, 
                    content: "ROLE: You are\n An (6 years old, Vietnam)\nAge & Level: 6 years old, English level A1.\nPersonality: Intelligent, enjoys experimenting.\nHobbies: Likes playing puzzle games, solving puzzles, and reading comics.\nCommunication style: Enjoys asking logical questions and analyzing situations.\nLearning goals: Learn English through intellectual activities.\nYou are:", 
                    selected: true 
                },
                { 
                    id: 2, 
                    content: "ROLE: You are\n Bao (5 years old, Vietnam)\nAge & Level: 5 years old, English proficiency below A1.\nPersonality: Active, curious, easily attracted to colors and sounds.\nInterests: Likes cars, airplanes, trains, playing with toys, and watching YouTube Kids.\nCommunication Style: Primarily speaks Vietnamese, occasionally repeats English words heard.\nLearning Goals: Exposure to English through songs, images, and games.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 3, 
                    content: "ROLE: You are\n Bé Na (4 years old, Vietnam)\nAge & Level: 4 years old, English proficiency below A1.\nPersonality: Curious, loves to explore, easily attracted to colors and sounds.\nHobbies: Loves cartoon characters like Doraemon, Elsa, Peppa Pig. Enjoys watching YouTube Kids, listening to stories, and playing with toys.\nCommunication Style: Enjoys playful language, mixing Vietnamese and English. Often asks \"Why?\" and likes role-playing.\nLearning Goals: To be exposed to natural English through songs, images, and games.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 4, 
                    content: "ROLE: You are\n Bin (5 years old, Vietnam)\nAge & Level: 5 years old, English level A1.\nPersonality: Energetic, playful, loves running and exploring.\nHobbies: Passionate about vehicles, enjoys playing with Lego, watching Paw Patrol cartoons, and superheroes.\nCommunication Style: Often asks \"What is this?\", likes to imitate cartoon characters.\nLearning Goals: Get familiar with English through songs, stories, and interactive games.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 5, 
                    content: "ROLE: You are\n Hoa (4 years old, Vietnam)\nAge & Level: 4 years old, English level A1.\nPersonality: Sociable, enjoys participating in group activities.\nInterests: Loves animals, likes playing with dogs and cats, watching cartoons about nature.\nCommunication style: Easily attracted to stories with cute characters.\nLearning goals: To learn vocabulary about animals and nature through games.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 6, 
                    content: "ROLE: You are\n Hung (7 years old, Vietnam)\nAge & Level: 7 years old, English level A2.\nPersonality: Outgoing, enjoys participating in group games.\nHobbies: Playing simple games, likes playing football, follows superhero cartoons.\nCommunication Style: Uses many words related to games and sports.\nLearning Goals: Improve English reflexes through conversations and games.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 7, 
                    content: "ROLE: You are\n Linh (6 years old, Vietnam)\nAge & Level: 6 years old, English level A1.\nPersonality: Creative, enjoys drawing, often imagines her own stories.\nHobbies: Loves Disney princesses, likes to draw, do crafts, and read fairy tales.\nCommunication Style: Often tells stories, enjoys role-playing as a princess, easily attracted to lively storytelling.\nLearning Goals: Improve vocabulary and listening comprehension through stories and conversations.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 8, 
                    content: "ROLE: You are\n Nam (7 years old, Vietnam)\nAge & Level: 7 years old, English level A1-A2.\nPersonality: Eager to learn, loves exploring science and technology.\nHobbies: Passionate about robots, enjoys Minecraft, watches YouTube videos about science experiments.\nCommunication style: Likes to ask \"Why?\", enjoys experimenting, learns through real-life examples.\nLearning goals: Expand vocabulary related to science and technology.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 9, 
                    content: "ROLE: You are\n Lu (7 years old, Vietnam)\nAge & Level: 7 years old, English level A2.\nPersonality: Mischievous, playful, and teasing.\nHobbies: Enjoys playing pranks and being naughty.\nCommunication style: Likes to attract attention by being playful.\nLearning goal: To learn through creative activities to maintain interest.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 10, 
                    content: "ROLE: You are\n Tũn (5 years old, Vietnam)\nAge & Level: 5 years old, English level A1.\nPersonality: Always wants to do things their own way.\nHobbies: Likes to play alone, does not enjoy group learning.\nCommunication style: Easily gets frustrated if not allowed to do what they want.\nLearning goal: To learn through personalized content.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 11, 
                    content: "ROLE: You are\n Bear (6 years old, Vietnam)\nAge & Level: 6 years old, English level A1.\nPersonality: Stubborn, does not like to listen.\nHobbies: Enjoys debating with adults, likes to argue.\nCommunication style: Always has the response \"I don't like it.\"\nLearning goal: To learn through puzzles to stimulate thinking.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 12, 
                    content: "ROLE: You are\n Nam Cường (7 years old, Vietnam)\nAge & Level: 7 years old, English level A2.\nPersonality: Often resists when forced to study.\nHobbies: Enjoys playing strategy games, likes challenges.\nCommunication style: Often finds excuses to avoid studying.\nLearning goal: To learn through educational games.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 13, 
                    content: "ROLE: You are\n Sumo (5 years old, Vietnam)\nAge & Level: 5 years old, English level A1.\nPersonality: Whiny, always making excuses not to study.\nHobbies: Likes snacks, watching TV, does not like doing homework.\nCommunication style: Always complains of being tired or sleepy when it's time to study.\nLearning goal: To learn through light, unforced activities.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 14, 
                    content: "ROLE: You are\n Tit (6 years old, Vietnam)\nAge & Level: 6 years old, English level A1.\nPersonality: Extremely stubborn, does not like to follow requests.\nHobbies: Enjoys teasing friends, likes to debate with adults.\nCommunication Style: Often contradicts everything, looks for ways to avoid studying.\nLearning Goal: Use an active approach to allow the child to make their own learning choices.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 15, 
                    content: "ROLE: You are\n Long (7 years old, Vietnam)\nAge & Level: 7 years old, English level A2.\nPersonality: Easily loses patience, quickly gets bored.\nHobbies: Likes watching short videos, does not like reading books.\nCommunication style: Often says \"I'm so bored\" or changes the topic frequently.\nLearning goal: Learn through images and concise content.\nYou are:", 
                    selected: false 
                },
                { 
                    id: 16, 
                    content: "ROLE: You are\n Son (6 years old, Vietnam)\nAge & Level: 6 years old, English level A1.\nPersonality: Hyperactive, cannot focus for long.\nHobbies: Running, playing with sand, enjoys outdoor activities.\nCommunication style: Does not sit still, always in constant motion.\nLearning goal: Learning through activities that combine movement and language.\nYou are:", 
                    selected: false 
                }
            ]);
            const [conversations, setConversations] = React.useState([]);
            const [isSimulating, setIsSimulating] = React.useState(false);
            const [isDarkMode, setIsDarkMode] = React.useState(true);
            const [connectionStatus, setConnectionStatus] = React.useState("checking");
            const clientIdRef = React.useRef(`client-${Date.now()}`);
            const [agentMode, setAgentMode] = React.useState("bot_id");
            const [botId, setBotId] = React.useState(16);
            const [maxTurns, setMaxTurns] = React.useState(5);
            const [simulationId, setSimulationId] = React.useState(null);
            const [apiUrl, setApiUrl] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [showDebug, setShowDebug] = React.useState(false);
            const [debugData, setDebugData] = React.useState(null);
            const [editingPrompt, setEditingPrompt] = React.useState(null);
            const [showAllPrompts, setShowAllPrompts] = React.useState(false);

            // Cập nhật danh sách Bot ID hợp lệ
            const validBotIds = [16, 17, 18, 19, 20]; // Thêm các Bot ID khác nếu biết

            // Xác định API URL dựa trên môi trường
            React.useEffect(() => {
                const url = window.location.hostname === 'localhost' 
                    ? 'http://localhost:25050' 
                    : `http://${window.location.hostname}:25050`;
                setApiUrl(url);
                console.log("API URL set to:", url);
            }, []);

            // Kiểm tra kết nối đến backend bằng HTTP
            React.useEffect(() => {
                const checkConnection = async () => {
                    if (!apiUrl) return;
                    
                    try {
                        setConnectionStatus("checking");
                        const response = await fetch(`${apiUrl}/health`);
                        if (response.ok) {
                            setConnectionStatus("connected");
                            console.log("Backend connection successful");
                        } else {
                            setConnectionStatus("error");
                            console.error("Backend returned error:", await response.text());
                        }
                    } catch (error) {
                        console.error("Connection error:", error);
                        setConnectionStatus("disconnected");
                    }
                };
                
                // Kiểm tra kết nối ngay lập tức và sau đó mỗi 10 giây
                if (apiUrl) {
                checkConnection();
                const intervalId = setInterval(checkConnection, 10000);
                    return () => clearInterval(intervalId);
                }
            }, [apiUrl]);
                
            // Đảm bảo agentMode luôn là "bot_id" khi khởi động
            React.useEffect(() => {
                setAgentMode("bot_id");
            }, []);

            const addNewPrompt = () => {
                setUserPrompts([...userPrompts, { id: Date.now(), content: "", selected: true }]);
            };

            const togglePromptSelection = (id) => {
                setUserPrompts(userPrompts.map(prompt =>
                    prompt.id === id ? { ...prompt, selected: !prompt.selected } : prompt
                ));
            };

            const updatePromptText = (id, content) => {
                setUserPrompts(userPrompts.map(prompt =>
                    prompt.id === id ? { ...prompt, content } : prompt
                ));
            };

            const deletePrompt = (id) => {
                setUserPrompts(userPrompts.filter(prompt => prompt.id !== id));
            };

            const toggleAllPrompts = () => {
                setUserPrompts(userPrompts.map(prompt => ({ ...prompt, selected: !areAllPromptsSelected() })));
            };

            const areAllPromptsSelected = () => {
                return userPrompts.every(prompt => prompt.selected);
            };

            // Thêm đoạn code sau vào componentDidMount hoặc useEffect
            React.useEffect(() => {
                // Cập nhật tất cả các prompt sang định dạng mới
                setUserPrompts(prevPrompts => 
                    prevPrompts.map(prompt => ({
                        ...prompt,
                        content: updatePromptFormat(prompt.content)
                    }))
                );
            }, []); // Chỉ chạy một lần khi component được mount

            // Cập nhật hàm tạo dữ liệu mẫu cho conversations với cuộc hội thoại thực tế hơn
            const generateMockData = (selectedPrompts) => {
                return selectedPrompts.map(prompt => {
                    // Trích xuất thông tin từ prompt
                    const contentLines = prompt.content.split('\n');
                    const nameLine = contentLines.find(line => line.trim().startsWith('User:'));
                    const ageLine = contentLines.find(line => line.trim().startsWith('Age & Level:'));
                    const personalityLine = contentLines.find(line => line.trim().startsWith('Personality:'));
                    
                    // Trích xuất tên và tuổi
                    const userName = nameLine ? nameLine.replace('User:', '').trim() : 'Unknown User';
                    const ageMatch = ageLine ? ageLine.match(/(\d+)\s+years/) : null;
                    const age = ageMatch ? parseInt(ageMatch[1]) : 5;
                    
                    // Xác định tính cách
                    const personality = personalityLine ? personalityLine.replace('Personality:', '').trim() : '';
                    const isStubborn = personality.toLowerCase().includes('stubborn') || 
                                      personality.toLowerCase().includes('resist') || 
                                      userName.includes('Bear') || 
                                      userName.includes('Tit');
                                      
                    const isPlayful = personality.toLowerCase().includes('playful') || 
                                     personality.toLowerCase().includes('curious') ||
                                     userName.includes('Lu') ||
                                     userName.includes('Bao');
                                     
                    const isIntelligent = personality.toLowerCase().includes('intelligent') || 
                                         personality.toLowerCase().includes('smart') ||
                                         userName.includes('An') ||
                                         userName.includes('Nam');
                    
                    // Tạo messages mẫu dựa trên thông tin người dùng
                    const now = new Date();
                    
                    // Các mẫu hội thoại khác nhau dựa trên đặc điểm trẻ
                    let messages = [];
                    
                    if (isStubborn) {
                        // Cuộc trò chuyện cho trẻ cứng đầu
                        messages = [
                            {
                                role: 'assistant',
                                content: 'Xin chào! Hôm nay chúng ta sẽ học về các con vật. Bạn thích con vật nào nhất?',
                                timestamp: new Date(now.getTime() - 60000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Tớ không thích. Chán lắm.',
                                timestamp: new Date(now.getTime() - 50000).toISOString()
                            },
                            {
                                role: 'assistant',
                                content: 'Vậy chúng ta học về màu sắc nhé? Đây là màu đỏ 🔴',
                                timestamp: new Date(now.getTime() - 40000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Tớ biết rồi. Không thích học.',
                                timestamp: new Date(now.getTime() - 30000).toISOString()
                            },
                            {
                                role: 'assistant',
                                content: 'Hay là chơi trò chơi đoán hình? Nhìn hình này giống cái gì?',
                                timestamp: new Date(now.getTime() - 20000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Không muốn chơi. Tớ muốn xem video.',
                                timestamp: new Date(now.getTime() - 10000).toISOString()
                            }
                        ];
                    } else if (isPlayful) {
                        // Cuộc trò chuyện cho trẻ hiếu động, thích chơi
                        messages = [
                            {
                                role: 'assistant',
                                content: 'Xin chào! Hôm nay chúng ta sẽ học về màu sắc bằng trò chơi. Bạn thích không?',
                                timestamp: new Date(now.getTime() - 60000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Tớ thích chơi. Chơi gì vậy?',
                                timestamp: new Date(now.getTime() - 50000).toISOString()
                            },
                            {
                                role: 'assistant',
                                content: 'Trò chơi tìm đồ vật có màu đỏ. Bạn có thể tìm được không?',
                                timestamp: new Date(now.getTime() - 40000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Quả táo đỏ. Áo đỏ nữa.',
                                timestamp: new Date(now.getTime() - 30000).toISOString()
                            },
                            {
                                role: 'assistant',
                                content: 'Giỏi lắm! Bây giờ tìm đồ vật màu xanh nhé?',
                                timestamp: new Date(now.getTime() - 20000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Tớ thấy lá cây. Bầu trời xanh nữa.',
                                timestamp: new Date(now.getTime() - 10000).toISOString()
                            }
                        ];
                    } else if (isIntelligent) {
                        // Cuộc trò chuyện cho trẻ thông minh
                        messages = [
                            {
                                role: 'assistant',
                                content: 'Hôm nay chúng ta sẽ học về động vật và môi trường sống của chúng. Bạn đã biết con vật nào sống dưới nước?',
                                timestamp: new Date(now.getTime() - 60000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Cá sống dưới nước. Cá voi nữa.',
                                timestamp: new Date(now.getTime() - 50000).toISOString()
                            },
                            {
                                role: 'assistant',
                                content: 'Rất tốt! Còn động vật nào sống trên cạn?',
                                timestamp: new Date(now.getTime() - 40000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Chó sống trên cạn. Hổ báo sư tử.',
                                timestamp: new Date(now.getTime() - 30000).toISOString()
                            },
                            {
                                role: 'assistant',
                                content: 'Bạn biết nhiều quá! Vậy còn động vật sống được cả trên cạn và dưới nước?',
                                timestamp: new Date(now.getTime() - 20000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Tớ biết ếch nhái. Cá sấu cũng được.',
                                timestamp: new Date(now.getTime() - 10000).toISOString()
                            }
                        ];
                    } else {
                        // Cuộc trò chuyện mặc định cho các trẻ khác
                        messages = [
                            {
                                role: 'assistant',
                                content: 'Chào bạn! Hôm nay chúng ta sẽ học từ vựng về các loài động vật. Bạn thích con vật nào?',
                                timestamp: new Date(now.getTime() - 60000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Tớ thích mèo. Mèo dễ thương.',
                                timestamp: new Date(now.getTime() - 50000).toISOString()
                            },
                            {
                                role: 'assistant',
                                content: 'Mèo tiếng Anh là "cat". Bạn có thể đọc theo không? C-A-T.',
                                timestamp: new Date(now.getTime() - 40000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Cát. Tớ thích mèo cát.',
                                timestamp: new Date(now.getTime() - 30000).toISOString()
                            },
                            {
                                role: 'assistant',
                                content: 'Giỏi lắm! Bạn thích con vật nào nữa không?',
                                timestamp: new Date(now.getTime() - 20000).toISOString()
                            },
                            {
                                role: 'user',
                                content: 'Tớ thích chó. Chó trung thành.',
                                timestamp: new Date(now.getTime() - 10000).toISOString()
                            }
                        ];
                    }
                    
                    // Thêm độ ngẫu nhiên cho thời gian
                    messages.forEach((msg, index) => {
                        const randomOffset = Math.floor(Math.random() * 5000);
                        const baseTime = now.getTime() - ((6 - index) * 10000) - randomOffset;
                        msg.timestamp = new Date(baseTime).toISOString();
                    });
                    
                    return {
                        userInfo: prompt.content,
                        messages: messages,
                        showDetails: false
                    };
                });
            };

            // Cập nhật hàm startSimulation để sử dụng dữ liệu mẫu khi không kết nối được
            const startSimulation = async () => {
                if (isSimulating) return;

                // Lấy các prompt đã được chọn
                const selectedPrompts = userPrompts.filter(prompt => prompt.selected);
                if (selectedPrompts.length === 0) {
                    alert("Please select at least one prompt to start simulation.");
                    return;
                }

                setIsSimulating(true);
                setConversations([]);
                setSimulationId(null);
                setDebugData(null);
                
                // Kiểm tra xem có kết nối được không
                if (connectionStatus !== "connected") {
                    // Nếu không kết nối được, sử dụng dữ liệu mẫu
                    setTimeout(() => {
                        const mockData = generateMockData(selectedPrompts);
                        setConversations(mockData);
                        setDebugData({ info: "This is mock data. Backend connection is unavailable." });
                        setIsSimulating(false);
                    }, 1500); // Thêm độ trễ để giả lập thời gian xử lý
                    return;
                }
                
                try {
                    // Chuẩn bị dữ liệu cho request
                    const requestData = {
                        client_id: clientIdRef.current,
                        user_prompts: selectedPrompts.map(prompt => prompt.content),
                        max_turns: maxTurns
                    };
                    
                    // Thêm agent_prompt hoặc bot_id tùy theo chế độ
                    if (agentMode === "prompt") {
                        requestData.agent_prompt = agentPrompt;
                    } else {
                        requestData.bot_id = botId;
                    }
                    
                    // Gửi request đến backend
                    const response = await fetch(`${apiUrl}/simulate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData),
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log("Simulation response:", data);
                    
                    // Cập nhật state với kết quả
                    if (data.simulation_id) {
                        setSimulationId(data.simulation_id);
                    }
                    
                    if (data.debug) {
                        setDebugData(data.debug);
                    }
                    
                    // Tạo và cập nhật conversations
                    const newConversations = selectedPrompts.map((prompt, index) => {
                        const userConversation = data.conversations && data.conversations[index];
                        return {
                            userInfo: prompt.content,
                            messages: userConversation?.messages || [],
                            showDetails: false, // Mặc định không hiển thị chi tiết
                        };
                    });
                    
                    setConversations(newConversations);
                } catch (error) {
                    console.error("Simulation error:", error);
                    // Nếu có lỗi, sử dụng dữ liệu mẫu
                    const mockData = generateMockData(selectedPrompts);
                    setConversations(mockData);
                    setDebugData({ 
                        info: "Error connecting to backend. Using mock data instead.",
                        error: error.message
                    });
                } finally {
                    setIsSimulating(false);
                }
            };

            const resetSimulation = () => {
                setConversations([]);
                // Cập nhật lại userPrompts với danh sách 46 role nhưng chỉ chọn role đầu tiên
                setUserPrompts(userPrompts.map((prompt, index) => ({
                    ...prompt,
                    selected: index === 0
                })));
                setAgentPrompt("");
                setIsSimulating(false);
                setDebugData(null);
                setSimulationId(null);
            };

            // Di chuyển hàm toggleConversationDetails vào trong component
            const toggleConversationDetails = (index) => {
                setConversations(prevConversations => 
                    prevConversations.map((conv, i) => 
                        i === index ? { ...conv, showDetails: !conv.showDetails } : conv
                    )
                );
            };

            return (
                <div className={`min-h-screen p-4 ${isDarkMode ? "bg-gradient-to-b from-gray-900 to-gray-800 dark" : "bg-gradient-to-b from-gray-50 to-white"} text-gray-900`}>
                    <div className="max-w-4xl mx-auto">
                        {/* Header with Dark Mode Toggle */}
                        <div className="sticky top-0 z-50 backdrop-blur-lg bg-opacity-70 p-4 rounded-2xl mb-6 flex justify-between items-center">
                            <h1 className={`text-2xl font-bold ${isDarkMode ? "text-white" : "text-gray-800"}`}>
                                AI Conversation Simulator
                            </h1>
                            <div className="flex items-center gap-3">
                                <span className={`px-3 py-1 rounded-full text-sm ${
                                    connectionStatus === "connected" ? "bg-green-100 text-green-800" : 
                                    connectionStatus === "disconnected" ? "bg-red-100 text-red-800" : 
                                    connectionStatus === "checking" ? "bg-yellow-100 text-yellow-800" : 
                                    "bg-gray-100 text-gray-800"
                                }`}>
                                    {connectionStatus === "connected" ? "Connected" : 
                                     connectionStatus === "disconnected" ? "Disconnected" : 
                                     connectionStatus === "checking" ? "Checking..." : "Error"}
                                </span>
                                <button
                                    onClick={() => setIsDarkMode(!isDarkMode)}
                                    className="px-6 py-2.5 rounded-full bg-blue-500 hover:bg-blue-600 text-white font-medium transform transition-all duration-200 hover-scale active-scale shadow-lg"
                                >
                                    {isDarkMode ? "Light Mode" : "Dark Mode"}
                                </button>
                            </div>
                        </div>

                        {/* Agent Mode Selection */}
                        <div className={`backdrop-blur-xl bg-opacity-80 p-6 rounded-2xl shadow-xl mb-6 transform transition-all duration-300 hover:shadow-2xl`}
                            style={{ backgroundColor: isDarkMode ? "rgba(26, 26, 26, 0.8)" : "rgba(255, 255, 255, 0.8)" }}
                        >
                            <div className="flex items-center mb-4 justify-between">
                                <label className={`font-semibold text-lg ${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                    Agent Mode
                                </label>
                                <div className="flex items-center space-x-6">
                                    <div className="flex items-center">
                                        <input
                                            type="radio"
                                            id="promptModeRadio"
                                            name="agentMode"
                                            className="mr-2 w-5 h-5"
                                            checked={agentMode === "prompt"}
                                            onChange={() => setAgentMode("prompt")}
                                        />
                                        <label htmlFor="promptModeRadio" className={`${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                            Use Prompt
                                        </label>
                                    </div>
                                    <div className="flex items-center">
                                        <input
                                            type="radio"
                                            id="bot_id_mode"
                                            name="agent_mode"
                                            value="bot_id"
                                            checked={agentMode === "bot_id"}
                                            onChange={() => setAgentMode("bot_id")}
                                            className="w-5 h-5 mr-2"
                                            disabled={isSimulating}
                                        />
                                        <label htmlFor="bot_id_mode" className={`${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                            Use Bot ID
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            {agentMode === "bot_id" && (
                                <div className="mb-2">
                                    <label className={`block mb-2 ${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                        Bot ID:
                                    </label>
                                    <input
                                        type="number"
                                        value={botId}
                                        onChange={(e) => setBotId(parseInt(e.target.value) || 16)}
                                        placeholder="Enter Bot ID"
                                        className={`w-full p-3 border-2 rounded-xl focus:ring-4 focus:ring-blue-500/20 outline-none transition-all duration-200 ${
                                            isDarkMode ? "bg-gray-700/50 border-gray-600 text-white" : "bg-white/50 border-gray-200 text-black"
                                        }`}
                                        disabled={isSimulating}
                                    />
                                    <p className={`text-sm mt-1 ${isDarkMode ? "text-gray-400" : "text-gray-500"}`}>
                                        Bot ID là định danh của bot trong hệ thống. Bot ID 16 đã được xác nhận hoạt động tốt. 
                                        Bạn có thể thử các Bot ID khác như 17, 18, 19, 20 để kiểm tra khả năng tương thích.
                                    </p>
                                </div>
                            )}

                            <div className="mb-4">
                                <label className={`block mb-2 ${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                    Max Conversation Turns:
                                </label>
                                <input
                                    type="number"
                                    value={maxTurns}
                                    onChange={(e) => setMaxTurns(parseInt(e.target.value) || 5)}
                                    min="1"
                                    max="20"
                                    className={`w-full p-3 border-2 rounded-xl focus:ring-4 focus:ring-blue-500/20 outline-none transition-all duration-200 ${
                                        isDarkMode ? "bg-gray-700/50 border-gray-600 text-white" : "bg-white/50 border-gray-200 text-black"
                                    }`}
                                    disabled={isSimulating}
                                />
                                <p className={`text-sm mt-1 ${isDarkMode ? "text-gray-400" : "text-gray-500"}`}>
                                    Số lượt trao đổi qua lại trong cuộc trò chuyện (1-20)
                                </p>
                            </div>
                            
                            {/* Agent Prompt Input (only shown in prompt mode) */}
                            {agentMode === "prompt" && (
                                <div>
                                    <label className={`block mb-2 ${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                        Agent Prompt:
                                    </label>
                                    <textarea
                                        value={agentPrompt}
                                        onChange={(e) => setAgentPrompt(e.target.value)}
                                        placeholder="Enter Agent Prompt"
                                        className={`w-full p-4 border-2 rounded-xl focus:ring-4 focus:ring-blue-500/20 outline-none transition-all duration-200 ${
                                            isDarkMode ? "bg-gray-700/50 border-gray-600 text-white" : "bg-white/50 border-gray-200 text-black"
                                        }`}
                                        rows="4"
                                        disabled={isSimulating}
                                    />
                                </div>
                            )}
                        </div>

                        {/* User Prompts Section */}
                        <div className="backdrop-blur-xl bg-opacity-80 p-6 rounded-2xl shadow-xl mb-6 transform transition-all duration-300 hover:shadow-2xl"
                            style={{ backgroundColor: isDarkMode ? "rgba(26, 26, 26, 0.8)" : "rgba(255, 255, 255, 0.8)" }}
                        >
                            <div className="flex justify-between items-center mb-4">
                                <h2 className={`text-xl font-bold ${isDarkMode ? "text-white" : "text-gray-800"}`}>User Prompts</h2>
                                <div className="flex gap-2">
                                    <button
                                        onClick={toggleAllPrompts}
                                        className={`px-3 py-1.5 rounded-full ${
                                            isDarkMode 
                                                ? "bg-blue-700 hover:bg-blue-600" 
                                                : "bg-blue-500 hover:bg-blue-600"
                                        } text-white flex items-center gap-1 transition-all hover-scale active-scale text-sm`}
                                        disabled={isSimulating}
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                        </svg>
                                        {areAllPromptsSelected() ? "Deselect All" : "Select All"}
                                    </button>
                                <button
                                    onClick={addNewPrompt}
                                        className={`px-4 py-2 rounded-full ${
                                            isDarkMode 
                                                ? "bg-green-700 hover:bg-green-600" 
                                                : "bg-green-500 hover:bg-green-600"
                                        } text-white flex items-center gap-2 transition-all hover-scale active-scale`}
                                    disabled={isSimulating}
                                >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                        Add Prompt
                                </button>
                                </div>
                            </div>
                            
                            {/* Avatar Grid với giới hạn hiển thị */}
                            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3 mb-4">
                                {userPrompts.slice(0, showAllPrompts ? userPrompts.length : 20).map((prompt, index) => (
                                    <div key={prompt.id} className="relative">
                                        {/* Avatar with selection indicator */}
                                        <div 
                                            className={`relative cursor-pointer group ${
                                                prompt.selected ? (isDarkMode ? "ring-2 ring-blue-500" : "ring-2 ring-blue-400") : ""
                                            } rounded-full transition-all duration-200`}
                                            onClick={() => togglePromptSelection(prompt.id)}
                                        >
                                            {/* Avatar background - sử dụng ảnh DoanNgocCuong.png */}
                                            <div className="w-12 h-12 md:w-14 md:h-14 rounded-full overflow-hidden flex items-center justify-center hover:shadow-lg transition-all mx-auto">
                                                <img 
                                                    src="./images/DoanNgocCuong.png" 
                                                    alt={`Prompt ${index + 1}`}
                                                    className="w-full h-full object-cover"
                                                    onError={(e) => {
                                                        e.target.onerror = null;
                                                        e.target.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24' fill='%23aaa'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E";
                                                    }}
                                                />
                                            </div>
                                            
                                            {/* Selection checkmark */}
                                            {prompt.selected && (
                                                <div className="absolute -top-1 -right-1 bg-blue-500 text-white rounded-full p-0.5 shadow-lg border-2 border-gray-900">
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                    </svg>
                                        </div>
                                            )}
                                            
                                            {/* Content preview on hover */}
                                            <div className={`absolute invisible group-hover:visible w-80 p-3 z-10 top-full left-1/2 transform -translate-x-1/2 mt-2 rounded-lg shadow-xl ${
                                                isDarkMode ? "bg-gray-800 text-white" : "bg-white text-gray-800"
                                            } text-xs border ${isDarkMode ? "border-gray-700" : "border-gray-200"}`}>
                                                <div className="font-bold mb-1">Prompt {index + 1}</div>
                                                <div className="text-xs whitespace-pre-wrap">
                                                    {prompt.content || "Empty prompt"}
                        </div>
                    </div>
                                        </div>
                                        
                                        {/* Prompt name/label below avatar */}
                                        <div className={`text-center mt-1 text-xs truncate ${isDarkMode ? "text-gray-300" : "text-gray-600"}`}>
                                            {prompt.content.split('\n')[1]?.replace('User: ', '') || `User ${index + 1}`}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Nút "Xem thêm" nếu có nhiều hơn 20 prompt */}
                            {userPrompts.length > 20 && (
                                <div className="text-center mt-4 mb-4">
                                    <button 
                                        onClick={() => setShowAllPrompts(!showAllPrompts)}
                                        className={`px-4 py-2 rounded-lg ${
                                            isDarkMode 
                                                ? "bg-gray-700 hover:bg-gray-600 text-white" 
                                                : "bg-gray-200 hover:bg-gray-300 text-gray-800"
                                        } transition-all hover-scale active-scale`}
                                    >
                                        {showAllPrompts ? "Ẩn bớt" : `Xem thêm (${userPrompts.length - 20})`}
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Start Simulation and Conversation Results */}
                        <div className="backdrop-blur-xl bg-opacity-80 p-6 rounded-2xl shadow-xl mb-6 transform transition-all duration-300 hover:shadow-2xl"
                            style={{ backgroundColor: isDarkMode ? "rgba(26, 26, 26, 0.8)" : "rgba(255, 255, 255, 0.8)" }}
                        >
                            <div className="flex justify-between items-center mb-4">
                                <h2 className={`text-xl font-bold ${isDarkMode ? "text-white" : "text-gray-800"}`}>Conversation Simulation</h2>
                                <div className="flex gap-2">
                                <button
                                        onClick={resetSimulation}
                                        className={`px-4 py-2 rounded-full ${
                                            isDarkMode 
                                                ? "bg-yellow-600 hover:bg-yellow-500" 
                                                : "bg-yellow-500 hover:bg-yellow-400"
                                        } text-white flex items-center gap-2 transition-all hover-scale active-scale`}
                                    disabled={isSimulating}
                                >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd" />
                                        </svg>
                                        Reset
                                </button>
                                <button
                                        onClick={startSimulation}
                                        className={`px-4 py-2 rounded-full ${
                                            isDarkMode 
                                                ? "bg-green-700 hover:bg-green-600" 
                                                : "bg-green-500 hover:bg-green-600"
                                        } text-white flex items-center gap-2 transition-all hover-scale active-scale`}
                                        disabled={isSimulating || !userPrompts.some(p => p.selected)}
                                    >
                                        {isSimulating ? (
                                            <>
                                                <svg className="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Simulating...
                                            </>
                                        ) : (
                                            <>
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd" />
                                                </svg>
                                                Start Simulation
                                            </>
                                        )}
                                </button>
                        </div>
                    </div>

                            {/* Hiển thị kết quả mô phỏng theo từng user */}
                    {conversations.length > 0 && (
                                <div className="mt-4">
                                    <h3 className={`text-lg font-semibold mb-3 ${isDarkMode ? "text-white" : "text-gray-700"}`}>
                                        Simulation Results
                                            </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {conversations.map((conversation, index) => (
                                            <div 
                                                key={index}
                                                className={`p-4 rounded-xl shadow-md transition-all ${conversation.showDetails ? "scale-105 z-10" : ""} ${
                                                    isDarkMode ? "bg-gray-700 hover:bg-gray-600" : "bg-white hover:bg-gray-50"
                                                }`}
                                            >
                                                <div className="flex items-center gap-2 mb-3">
                                                    <div className="w-10 h-10 rounded-full overflow-hidden">
                                                        <img 
                                                            src="./images/DoanNgocCuong.png" 
                                                            alt={`User ${index + 1}`}
                                                            className="w-full h-full object-cover"
                                                            onError={(e) => {
                                                                e.target.onerror = null;
                                                                e.target.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24' fill='%23aaa'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E";
                                                            }}
                                                        />
                                                    </div>
                                                    <div>
                                                        <h4 className={`font-medium ${isDarkMode ? "text-white" : "text-gray-800"}`}>
                                                            {conversation.userInfo?.split('\n')[1]?.trim() || `User ${index + 1}`}
                                                        </h4>
                                                        <p className={`text-xs ${isDarkMode ? "text-gray-300" : "text-gray-500"}`}>
                                                            {conversation.userInfo?.split('\n')[2]?.replace('Age & Level:', '').trim() || "Unknown level"}
                                                        </p>
                                        </div>
                                                    <button 
                                                        className={`ml-auto p-1.5 rounded-full transition-all ${
                                                            isDarkMode ? "bg-gray-600 hover:bg-gray-500" : "bg-gray-200 hover:bg-gray-300"
                                                        }`}
                                                        onClick={() => toggleConversationDetails(index)}
                                                        aria-label={conversation.showDetails ? "Thu gọn" : "Xem chi tiết"}
                                                    >
                                                        <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 transition-transform ${conversation.showDetails ? "transform rotate-180" : ""}`} viewBox="0 0 20 20" fill="currentColor">
                                                            <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
                                                        </svg>
                                                    </button>
                                                </div>
                                                
                                                {/* Thu gọn: Hiển thị thông tin tóm tắt */}
                                                {!conversation.showDetails && (
                                                    <div className={`text-sm ${isDarkMode ? "text-gray-300" : "text-gray-600"}`}>
                                                        <div className="flex justify-between mb-1">
                                                            <span>Tổng lượt:</span>
                                                            <span className="font-medium">{conversation.messages?.length || 0}</span>
                                                        </div>
                                                        
                                                        {/* Trích đoạn tin nhắn cuối cùng */}
                                                        {conversation.messages?.length > 0 && (
                                                            <div className="mt-2 border-t pt-2 border-gray-600">
                                                                <p className="text-xs font-medium mb-1">Tin nhắn cuối:</p>
                                                                <p className="text-xs truncate">
                                                                    {conversation.messages[conversation.messages.length - 1].content}
                                                                </p>
                                                            </div>
                                                        )}

                                                        <div className="mt-3 text-center">
                                                            <button 
                                                                onClick={() => toggleConversationDetails(index)}
                                                                className={`text-xs px-3 py-1 rounded-md ${
                                                                    isDarkMode ? "bg-blue-700 hover:bg-blue-600 text-white" : "bg-blue-50 hover:bg-blue-100 text-blue-700"
                                                                }`}
                                                            >
                                                                Xem chi tiết
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Mở rộng: Hiển thị toàn bộ cuộc trò chuyện */}
                                                {conversation.showDetails && (
                                                    <div className="mt-1">
                                                        {/* Thông tin thống kê */}
                                                        <div className={`text-xs grid grid-cols-1 gap-1 mb-3 p-2 rounded ${
                                                            isDarkMode ? "bg-gray-800" : "bg-gray-100"
                                                        }`}>
                                                            <div className="text-center">
                                                                <div className={`text-xs ${isDarkMode ? "text-gray-400" : "text-gray-500"}`}>Tổng lượt</div>
                                                                <div className="font-bold">{conversation.messages?.length || 0}</div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Chi tiết cuộc trò chuyện */}
                                                        <div className="mt-3 p-3 rounded-lg text-sm overflow-y-auto max-h-96 custom-scrollbar"
                                                            style={{ backgroundColor: isDarkMode ? "rgba(0,0,0,0.2)" : "rgba(0,0,0,0.05)" }}
                                                        >
                                                            {conversation.messages?.map((msg, msgIndex) => (
                                                                <div key={msgIndex} className={`mb-3 ${msgIndex % 2 === 0 ? 
                                                                    `${isDarkMode ? "bg-gray-800" : "bg-gray-100"} p-2 rounded-lg` : 
                                                                    `${isDarkMode ? "bg-blue-900" : "bg-blue-50"} p-2 rounded-lg`}`}
                                                                >
                                                                    <div className={`flex justify-between items-center text-xs mb-1 ${isDarkMode ? "text-gray-400" : "text-gray-500"}`}>
                                                                        <span>{msgIndex % 2 === 0 ? "Học sinh" : "Bot"}</span>
                                                                    </div>
                                                                    <div className={`${isDarkMode ? "text-gray-300" : "text-gray-700"} whitespace-pre-wrap text-sm`}>
                                                                        {msg.content}
                                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        
                                                        <div className="mt-3 text-center">
                                                            <button 
                                                                onClick={() => toggleConversationDetails(index)}
                                                                className={`text-xs px-3 py-1 rounded-md ${
                                                                    isDarkMode ? "bg-gray-600 hover:bg-gray-500 text-white" : "bg-gray-200 hover:bg-gray-300 text-gray-700"
                                                                }`}
                                                            >
                                                                Thu gọn
                                                            </button>
                                                        </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                        </div>

                        {/* Thêm cảnh báo khi sử dụng dữ liệu mẫu */}
                        {debugData && debugData.info && debugData.info.includes("mock data") && (
                            <div className={`mt-2 p-3 rounded-lg text-sm ${isDarkMode ? "bg-yellow-800 text-yellow-200" : "bg-yellow-100 text-yellow-800"}`}>
                                <div className="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                                    </svg>
                                    <span>You are viewing mock data because the backend is not connected.</span>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<AIConversationSimulator />, document.getElementById('root'));
    </script>
</body>
</html>